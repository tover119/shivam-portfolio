<!DOCTYPE html>
<html>
    <style>
        .lineFemale {
            fill: none;
            stroke:#ff7ae0;
            stroke-width: 3;
        }
        .lineMale {
            fill: none;
            stroke:#61b8ff;
            stroke-width: 3;
        }

        .grid line {
            stroke: lightgrey;
             stroke-opacity: 0.7;
             shape-rendering: crispEdges;
        }

        #buttonRow {
            position: absolute;
            left: 115px;
            top: 75px;
        }
        #select {
            position: absolute;
            left: 115px;
        }

        .active, .btn:hover {
            background-color: #666;
            color: white;
        }


        /* Tooltip CSS */
        .d3-tip {
            line-height: 1.5;
            font-weight: 400;
            font-family:"avenir next", Arial, sans-serif;
            padding: 6px;
            background: rgba(0, 0, 0, 0.6);
            color: rgb(172, 243, 248);
            border-radius: 1px;
            pointer-events: none;
        }

        /* Creates a small triangle extender for the tooltip */
        .d3-tip:after {      
            box-sizing: border-box;
            display: inline;
            font-size: 8px;
            width: 100%;
            line-height: 1.5;
            color: rgba(0, 0, 0, 0.6);
            position: absolute;
            pointer-events: none;
            
        }

        /* Northward tooltips */
        .d3-tip.n:after {
            content: "\25BC";
            margin: -1px 0 0 0;
            top: 100%;
            left: 0;
            text-align: center;
        }

        /* Eastward tooltips */
        .d3-tip.e:after {
            content: "\25C0";
            margin: -4px 0 0 0;
            top: 50%;
            left: -8px;
        }

        /* Southward tooltips */
        .d3-tip.s:after {
            content: "\25B2";
            margin: 0 0 1px 0;
            top: -8px;
            left: 0;
            text-align: center;
        }

        /* Westward tooltips */
        .d3-tip.w:after {
            content: "\25B6";
            margin: -4px 0 0 -1px;
            top: 50%;
            left: 100%;
        }
        /* Set gray background color and 100% height */
        .sidenav {
            background-color: #3d3d3d;
            height: 100%;
        }
        p, #prompt, #description {
            color: #ffff;
        }
        .row.content {height: 1500px}

        .col-sm-9 {
            background-color: #ebebeb;
            height: 100%;
        }

        #chart {
            position:relative;
            left: 100px;
            max-width: 1200px;
            background-color: #ffffff;
            border: 5px solid #3d3d3d;

        }

    </style>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
        <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.7.1/d3-tip.min.js"></script>
    </head>

    <body>
        <div class="container-fluid">
            <div class="row content">
                <div class="col-sm-3 sidenav">
                    <br>
                    <p>SUICIDE RATES BY COUNTRY AND AGE</p>
                    <br>
                    <span id="prompt">The graphs shown on this page provide insight into world suicide statistics spanning several years. All numbers are normalized by population and show the amount of deaths per 100,000 people.
                        <br/><br/>Navigate through the scenes using the buttons above each chart to show different metrics. Date parameters and tooltips are available to provide further insight into the material displayed in each chart.
                        <br/>______________________________________________________
                    </span>
                    <br><br>
                    <span id="description">This shows text for chart one</span>
                </div>
            
            <div class="col-sm-9">

                <div id="buttonRow" class="btn-group">
                    <label>Scene Navigation:</label><br>
                    <button class="btn btn-primary" id="previous" onclick="setScene(scene-1)" disabled>Previous</button>
                    <button class="btn active" id="1" onclick="setScene(1)">1</button>
                    <button class="btn" id="2" onclick="setScene(2)">2</button>
                    <button class="btn" id="3" onclick="setScene(3)">3</button>
                    <button class="btn btn-primary" id="next" onclick="setScene(scene+1)">Next</button>
                </div><br><br><br><br><br><br><br><br>
                    <div id="chart"></div><br>
                    <div id="select">
                        <label>Select Year:</label>
                        <select id="year"></select>
                        <br><br>
                    </div>
                </div>
            </div>
            </div>
            
        </div>
    <script>

            // Set tooltips
            const tip = d3.tip()
                .attr('class', 'd3-tip')
                .offset([-10, 0])
                .html(function(d) {
                    if (d.suicides == 0) {
                        return `<strong>Country: </strong><span class='details'>${d.properties.name}<br></span><strong># of Suicides: No Data Found`;
                    }else{
                        return `<strong>Country: </strong><span class='details'>${d.properties.name}<br></span><strong># of Suicides: </strong><span class='details'>${d.suicides}</span>`;
                    }}); 

            var margin = {top: 75, bottom: 75, right: 100, left: 125};
            var width = 1200 - margin.left - margin.right;
            var height = 700 - margin.top - margin.bottom;

            //scene number
            var scene = 1;
            var yearVal = 1990;

            //Date
            var dateFormat = d3.timeFormat("%Y");

            //Screen translation coordinates
            var x = d3.scaleLinear().range([0, width]);
            var y = d3.scaleLinear().range([height, 0]);

            //Set up line function
            var line = d3.line()
                .x(function(d, i) { return x(d.year); })
                .y(function(d) { return y(d.suicides); })
                .curve(d3.curveCardinal)

            //SVG
            var svg = d3.select("body").select("#chart")
                .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


            //make first scene
            makeOverviewScene();

            // gridlines in x axis function
            function make_x_gridlines() {		
                return d3.axisBottom(x)
                    .ticks(10)
            }

            // gridlines in y axis function
            function make_y_gridlines() {		
                return d3.axisLeft(y)
                    .ticks(20)
            }
            
            function makeOverviewScene() {
                var hide = document.getElementById('select');
                hide.style.visibility = 'hidden';
                //Read in the data
                d3.csv("suicide-death-rates.csv").then(function(data) {

                    //Translate number values
                    data.forEach(function(d) {
                        d.year = +d.year;
                        d.suicides = +d.suicides;
                        d.population = +d.population;
                        d.gdp = +d.gdp;
                    })   

                    //Nest the data by year and sum the totat suicide no.
                    var overview = d3.nest()
                        .key(function(d) { return d.code; }).sortKeys(d3.ascending)
                        .rollup(function(country) { 
                            return d3.sum(country, function(g) { return g.suicides; });
                            }).entries(data)
                        .map(function(d) {
                            return {code: d.key, suicides: d.value };
                        });

                    var path = d3.geoPath();
                    var projection = d3.geoRobinson()
                        .scale(210)
                        .translate([width/2.2, height/2 ])
                    var path = d3.geoPath()
                        .projection(projection);

                    svg.call(tip);


                    // Data and color scale
                    var map = d3.map();
                    var colorScale = d3.scaleThreshold()
                        .domain([100, 200, 300, 400, 500, 600, 700, 800, 900, 1000, 2000, 3000])
                        .range(['rgb(237,248,255)',
                        'rgb(197,222,240)', 
                        'rgb(162,204,232)',
                        'rgb(136,186,219)', 
                        'rgb(105,163,201)',
                        'rgb(73,140,184)',
                        'rgb(48,113,156)',
                        'rgb(30,93,135)',
                        'rgb(20,81,122)',
                        'rgb(10,62,97)',
                        'rgb(4,51,82)',
                        'rgb(0, 29, 48)']);

                    // Load external data and boot
                    d3.json("topology.json").then(function(topo) {
                        // Draw the map
                        overview.forEach(function(d) {
                            map.set(d.code, d.suicides);
                        })

                        svg.append("g")
                            .attr("class", "countries")
                            .selectAll("path")
                            .data(topo.features)
                            .enter().append("path")
                                .attr("fill", function (d){
                                    // Pull data for this country
                                    
                                    d.suicides = map.get(d.id) || 0;
                                    // Set the color
                                    return colorScale(d.suicides);
                                })
                                .attr("d", path)
                                .on('mouseover',function(d){
                                    tip.show(d);
                                    d3.select(this)
                                    .style('opacity', .8)
                                    .style('stroke-width', 3);
                                })
                                .on('mouseout', function(d){
                                    tip.hide(d);
                                    d3.select(this)
                                    .style('opacity', 1)
                                    .style('stroke-width',0.3);
                                });
                    })
                    .catch(function(error) {
                        console.log(error);    
                    })
                })
                .catch(function(error) {
                    console.log(error);
                })
            }

            function makeAgeScene() {
                var hide = document.getElementById('select');
                hide.style.visibility = 'visible';
                //Read in the data
                d3.csv("suicideAge.csv").then(function(data) {
                    console.log(data);
                    var year  = [...new Set(data.map(function(d) { return +d.year; }))];

                    var options = d3.select("#select").select("#year").selectAll("option")
                        .data(year)
                    .enter().append("option")
                        .text(function(d) { return d; })

                    //Make gridlines
                    svg.append("g")
                        .attr("class", "grid")
                        .call(make_y_gridlines()
                            .tickSize(-width)
                            .tickFormat(""));
                            
                    //Group for rect and text
                    var gs = svg.append("g");
                    
                    //Translate number values
                    data.forEach(function(d) {
                        d.year = +d.year;
                        d.suicides = +d.suicides;
                    })

                    var xScale = d3.scaleBand()
                        .range([0, width])
                        .domain(data.map(function(d) { return d.age; }));

                    var yScale = d3.scaleLinear()
                        .rangeRound([height, 0])
                        .domain([0, d3.max(data, function(d) { return d.suicides; })]);


                    var xAxis = d3.axisBottom()
                        .scale(xScale);

                    var yAxis = d3.axisLeft()
                        .scale(yScale);

                    buildAxis(xAxis, "Age Group", yAxis, "# of suicides (Per 100,000 People");
                    

                    var filtered = data.filter(function(f) { return f.year == yearVal});
                    var barWidth = width/filtered.length;

                    var select = d3.select("#select").select("#year")
		                .on("change", function() {
			                update(this.value)
		                })

                    console.log(filtered);

                    gs.selectAll("rect")
                        .data(filtered)
                        .enter().append("rect")
                        .style("fill", "steelblue")
                        .attr("width", barWidth - 5)
                        .attr("x", function(d, i) { return i * barWidth; })
                        .attr("y", function(d) { return yScale(d.suicides); })
                        .attr("height", function(d) { return height - yScale(d.suicides) ; })

                    //Create labels
                    gs.selectAll("texts")
                        .data(filtered)
                        .enter()
                        .append("text")
                        .text(function(d) {
                            return d.suicides;
                        })
                        .attr("text-anchor", "middle")
                        .attr("x", function(d, i) { return (i * barWidth) + barWidth/2; })
                        .attr("y", function(d) { return yScale(d.suicides) -10; })
                        .attr("font-family", "sans-serif")
                        .attr("font-size", "11px")
                        .attr("fill", "black");

                    function update(input) {

                        yearVal = input;

                        var filtered = data.filter(function(f) { return f.year == input});
                        var barWidth = width/filtered.length;

                        gs.selectAll("rect")
                        .data(filtered)
                        .transition()
                            .delay(function(d, i) {
                                return i * 100;
                            })
                            .duration(1000)
                            .ease(d3.easeCubic)
                            .attr("y", function(d) {
                                return yScale(d.suicides);
                            })
                            .attr("height", function(d) {
                                return height - yScale(d.suicides);
                            })
                            

                        gs.selectAll("text")
                            .data(filtered)
                            .transition()
                                .delay(function(d, i) {
                                    return i * 100;
                                })
                                .duration(1000)
                                .ease(d3.easeCubic)
                                .text(function(d) {
                                    return d.suicides;
                                })
                                .attr("text-anchor", "middle")
                                .attr("x", function(d, i) { return (i * barWidth) + barWidth/2; })
                                .attr("y", function(d) { return yScale(d.suicides) - 10; })
                                .attr("font-family", "sans-serif")
                                .attr("font-size", "11px")
                                .attr("fill", "black");
                    }                    
                })
                .catch(function(error) {
                    console.log(error);
                })
            }

            function makeGenderScene() {
                var hide = document.getElementById('select');
                hide.style.visibility = 'hidden';
                //Read in the data
                d3.csv("suicideGender.csv").then(function(data) {

                    //Translate number values
                    data.forEach(function(d) {
                        d.year = +d.year;
                        d.suicides = +d.suicides;
                    })

                    var male = d3.nest()
                        .key(function(d) { return d.year; }).sortKeys(d3.ascending)
                        .rollup(function(year) { 
                            return d3.sum(year, function(g) { 
                                return g.male; });
                        }).entries(data)
                        .map(function(d) {
                            return {year: d.key, suicides: d.value };
                        });
                    
                    console.log(male);
                    var female = d3.nest()
                        .key(function(d) { return d.year; }).sortKeys(d3.ascending)
                        .rollup(function(year) { 
                            return d3.sum(year, function(g) { 
                                return g.female; });
                        }).entries(data)
                        .map(function(d) {
                            return {year: d.key, suicides: d.value };
                        });

                    x.domain(d3.extent(male, function(d) { return d.year; }));
                    y.domain(d3.extent([0].concat(male.map(function(d) { return d.suicides; }))
                    .concat(female.map(function(d) { return d.suicides; }))));

                    var xAxis = d3.axisBottom().scale(x)
                        .ticks(20);

                    var yAxis = d3.axisLeft().scale(y)
                        .ticks(20);

                    buildAxis(xAxis, "Year", yAxis, "# of suicides (world total) - Per 100,000 people");

                    //Make gridlines
                    svg.append("g")
                        .attr("class", "grid")
                        .attr("transform", "translate(0," + height + ")")
                        .call(make_x_gridlines()
                            .tickSize(-height)
                            .tickFormat(""));

                    //Make gridlines
                    svg.append("g")
                        .attr("class", "grid")
                        .call(make_y_gridlines()
                            .tickSize(-width)
                            .tickFormat(""));

                    //Male Path
                    svg.append("path")
                        .datum(male)
                        .attr("class", "lineMale")
                        .attr("d", line);

                    //Male Path
                    svg.append("path")
                        .datum(female)
                        .attr("class", "lineFemale")
                        .attr("d", line);

                    //Append the dots
                    svg.selectAll("circle")
                        .data(male)
                        .enter().append("circle")
                            .attr("cx", function(d, i) { return x(d.year); })
                            .attr("cy", function(d) { return y(d.suicides);})
                            .attr("r", 4);

                    svg.selectAll("circles")
                        .data(female)
                        .enter().append("circle")
                            .attr("cx", function(d, i) { return x(d.year); })
                            .attr("cy", function(d) { return y(d.suicides);})
                            .attr("r", 4);
                })
                .catch(function(error) {
                    console.log(error);
                })
            }
            function buildAxis(xAxis, xTag, yAxis, yTag) {
                //Call the x axis in a group tag
                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis); // Create an axis component with d3.axisBottom

                //label x axis
                svg.append("text")
                    .attr("transform", "translate(" + width/2 + "," + (height + 50) +")")
                    .text(xTag)

                //Call the y axis in a group tag
                svg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis); // Create an axis component with d3.axisLeft

                //Label y axis
                svg.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -85)
                    .attr("x", 0-(height/2)-100)
                    .attr("dy", "1em")
                    .text(yTag);
            }

            function setScene(sceneNum) {

                scene = sceneNum;
                // Get the container element
                var btnContainer = document.getElementById("buttonRow");
                var text = document.getElementById("description");


                // Get all buttons with class="btn" inside the container
                var btns = btnContainer.getElementsByClassName("btn");

                //Set active button
                var current = document.getElementsByClassName("active");
                current[0].className = current[0].className.replace(" active", "");
                btns[scene].className += " active";

                //Clear the canvas
                svg.selectAll("*").remove();

                var prev = document.getElementById("previous");
                var next = document.getElementById("next");

                prev.disabled = false;
                next.disabled = false;

                switch(sceneNum) {
                    case 1:
                        prev.disabled = true;
                        next.disabled = false;
                        text.innerText = "This is text for scene 1";
                        makeOverviewScene();
                        break;
                    case 2:
                        text.innerText = "This is text for scene 2";
                        makeAgeScene();
                        break;
                    case 3:
                        next.disabled = true;
                        prev.disabled = false;
                        text.innerText = "This is text for scene 3";
                        makeGenderScene();
                        break;
                }
            }

        </script>
    </body>
</html>

